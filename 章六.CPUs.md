# 章六.CPUs

CPUs执行所有的软件，普遍是性能分析开始的重点。如果你发现工作负载受到CPU的限制(“CPU极限”)，你可以进行使用CPU和处理器的工具进行深入的研究。有无数的采样分析器和度量指标可用于帮助你了解CPU使用情况。尽管如此(如果可能令人惊讶的话)，在许多领域BPF跟踪仍然有助于深入CPU分析。

学习目标

- 理解CPU模式，CPU调度器行为，CPU caches
- 理解CPU调度器的范围，使用情况，使用BPF进行硬件分析
- 学习正确分析CPU性能的策略
- 解决运行时间短的进程消耗CPU资源的问题
- 发现并量化运行队列延迟问题
- 通过分析堆栈跟踪和函数计数来确定CPU使用情况
- 确定线程阻塞并让出CPU的原因
- 通过跟踪系统调用来理解系统的CPU时间
- 探究软中断和硬中断对CPU消耗
- 使用自定义bpftrace单行方式探究CPU使用情况

本章你需要的背景知识，理解CPU分析，总结CPU调度器和CPU缓存的行为。我探究了BPF可以回答哪些问题，并提供了一个可以遵循的总体策略。为了避免重复造轮子并且直接深入分析，我将先总结传统的CPU工具，然后是BPF工具，包括BPF单行方式。自选练习在章尾。

## 背景

为了理解CPU分析的前景，本节总结了CPU模式和内核用户、CPU调度器的操作以及CPU硬件缓存。

### CPU Modes

CPU和其他资源由内核管理，内核以一种称为系统模式的特殊权限状态运行。用户级应用程序运行在用户模式，只能通过内核请求资源。这些请求可以是显式的，比如系统调用，也可以是隐式的，比如内存加载和存储触发的页面错误。内核跟踪CPU非空闲的时间，像在用户和系统模式下花费的CPU时间。各种性能工具都显示了用户/系统模式下分别的时间。

内核通常只按需运行，由系统调用和中断触发的时候。也有一些例外，例如在后台运行的内核线程占用了CPU资源。这方面的一个例子是内核在非一致性内存访问系统（NUMA）上平衡内存页，会消耗大量的CPU，这就没有来自用户级的显式请求的资源应用程序(可以调优或禁用)。一些文件系统也有后台活动，比如周期性的计算校验和以验证数据完整性。

### CPU调度器

内核还负责为用户程序提供CPU资源，用户程序通过CPU调度器进行管理。调度器主要服务的是线程（或者说调用栈），这些线程属于用户进程或内核。还有一些其他的CPU活动包括中断行为：正在运行的软件能够触发软中断，还有硬件触发的硬中断。章6-1展现CPU调度器，描述等待运行队列的线程，以及它们如何在不同的线程状态之间切换。

![scheduler](img/CPU scheduler.png)

图中显示了三个线程状态:ON-PROC为正在运行在CPU的线程态，RUNNABLE为可以运行正在排队等待的线程，SLEEP为被其他事件阻塞不能运行的线程态，包括不可中断态。正在等待的线程按优先级排序，优先级可由
